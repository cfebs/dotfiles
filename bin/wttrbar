#!/usr/bin/env bash

WTTR_LOCATION="${WTTR_LOCATION:-NYC}"
FILE_OUT="/tmp/wttrbar.txt"
FORMAT="%c%f+%l"
res="$(curl -m10 -sL "https://wttr.in/${LOCATION}?m&format=${FORMAT}")"
rc=$?

if [[ "$rc" != "0" ]]; then
    truncate -s0 "$FILE_OUT"
    echo "Removing $FILE_OUT, return code $rc" 1>&2
    exit 0
fi

if echo "$res" | grep -q 'weather report for the default city'; then
    echo "No weather data" > "$FILE_OUT"
    exit 0
fi

if [[ "$FORMAT" == "3" ]] || [[ "$FORMAT" =~ "%c" ]]; then
	# remove first space from the unicode format for nicer spacing
	echo "$res" | sed 's/ //' > "$FILE_OUT"
else
	echo "$res" > "$FILE_OUT"
fi


echo "Wrote $FILE_OUT"
exit 0
